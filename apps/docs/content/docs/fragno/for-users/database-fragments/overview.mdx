---
title: Overview
description: Getting started with database-enabled Fragments
---

import { Callout } from "fumadocs-ui/components/callout";
import { Step, Steps } from "fumadocs-ui/components/steps";

Some Fragno Fragments include a built-in database layer for persistent storage. When integrating
these Fragments, you typically provide a **database adapter** that connects the Fragment to your
existing database. If `better-sqlite3` is installed, Fragno can default to a local SQLite file per
fragment under `FRAGNO_DATA_DIR` (default: `~/.fragno`).

<Callout title="Fragment Handles Schema" type="info">
  The Fragment defines its own schema and handles migrations. You just provide the database
  connection - no need to manually create tables or write SQL.
</Callout>

## Identifying Database Fragments

A Fragment uses the database layer if its documentation mentions `FragnoPublicConfigWithDatabase` or
requires a `databaseAdapter` option.

Check the Fragment's creation function:

```typescript
// Fragment without database
createExampleFragment(config, options);

// Fragment with database - may require databaseAdapter
createCommentFragment(config, { databaseAdapter });
```

## Quick Start

<Steps>

<Step>
### Installation

```npm
npm install @fragno-dev/db
```

And install the CLI to perform migrations / schema generation:

```npm
npm install --save-dev @fragno-dev/cli
```

</Step>

<Step>
<a id="choose-your-workflow"></a>
### Choose Your Workflow

Fragno uses a single runtime adapter (`SqlAdapter`) for all SQL databases. You choose the schema
output format that matches your workflow: SQL (default), Drizzle, or Prisma.

Start here: [Database Adapter](/docs/fragno/for-users/database-fragments/database-adapter)

</Step>

<Step>
### Create Database Adapter

Adapters are configured with a **Kysely `Dialect`** plus a **Fragno `driverConfig`** (they must
match). See [Database Adapter](/docs/fragno/for-users/database-fragments/database-adapter) for the
full setup and driver details.

```typescript title="lib/database-adapter.ts"
import { SqlAdapter } from "@fragno-dev/db/adapters/sql";
import { PostgresDialect } from "@fragno-dev/db/dialects";
import { NodePostgresDriverConfig } from "@fragno-dev/db/drivers";
import { Pool } from "pg";

const dialect = new PostgresDialect({
  pool: new Pool({ connectionString: process.env.DATABASE_URL }),
});

export const fragmentDbAdapter = new SqlAdapter({
  dialect,
  driverConfig: new NodePostgresDriverConfig(),
});
```

If you're using Prisma with SQLite, set `sqliteProfile: "prisma"` on the `SqlAdapter`.

</Step>

<Step>
### Pass Adapter to Fragment

```typescript title="lib/comment-fragment-server.ts"
import { createCommentFragment } from "@fragno-dev/comment-fragment";
import { fragmentDbAdapter } from "./database-adapter";

export function createCommentFragmentInstance() {
  return createCommentFragment(
    {
      // Fragment-specific config
    },
    {
      databaseAdapter: fragmentDbAdapter,
    },
  );
}

// IMPORTANT: Export the Fragment so it's accessible by the Fragno CLI.
export const fragment = createCommentFragmentInstance();
```

If `better-sqlite3` is installed, you can omit `databaseAdapter` to use the default local SQLite
file.

</Step>

<Step>
### Migrate your Database

Generate and apply database migrations (SQL output is the default):

```npm
# Generate SQL migrations
npx fragno-cli db generate lib/comment-fragment-server.ts

# Or apply migrations directly
npx fragno-cli db migrate lib/comment-fragment-server.ts
```

For schema outputs, choose an explicit format:

```npm
# Drizzle schema output
npx fragno-cli db generate lib/comment-fragment-server.ts --format drizzle -o schema/fragno-schema.ts

# Prisma schema output
npx fragno-cli db generate lib/comment-fragment-server.ts --format prisma -o prisma/schema/fragno.prisma
```

For details on the CLI commands, see the [CLI Reference](/docs/reference/cli).

</Step>

</Steps>

## Supported Databases

The SqlAdapter supports:

- **PostgreSQL**
- **MySQL**
- **SQLite**

The adapter automatically handles database-specific SQL generation.

## Server-Only Sharding

Database fragments support **server-only sharding** through `shardingStrategy`. If you do not set a
strategy, no sharding is applied.

```typescript title="lib/comment-fragment-server.ts"
import { createCommentFragment } from "@fragno-dev/comment-fragment";

export function createCommentFragmentInstance() {
  return createCommentFragment(
    {
      shardingStrategy: { mode: "row" },
    },
    { databaseAdapter },
  );
}
```

`shardingStrategy` modes:

- `mode: "row"` injects `_shard` filters into reads and writes.
- `mode: "adapter"` disables row-level filtering but still records `_shard` for traceability. In
  adapter mode, you must set a non-null shard per request.

### Durable Hooks Processor Scope

When sharding is enabled, you can run durable hook processing **per shard** or **globally** by
passing a scope to `createDurableHooksProcessor`:

```ts
import { createDurableHooksProcessor } from "@fragno-dev/db";

const perShard = createDurableHooksProcessor(fragment, {
  scope: { mode: "shard", shard: "tenant-a" },
});

const global = createDurableHooksProcessor(fragment, {
  scope: { mode: "global" },
});
```

- `mode: "shard"` sets the shard context and runs with shard filtering enabled.
- `mode: "global"` disables row-level shard filters so one processor can drain hooks across all
  shards. Use this only for trusted, centralized maintenance or background workers.

### Setting the Shard in Middleware

Shards are resolved by integrator middleware. This must run for **all** fragment routes, including
internal outbox/sync routes.

```typescript title="lib/comment-fragment-server.ts"
import { getInternalFragment } from "@fragno-dev/db";

const shardMiddleware = async (input, output) => {
  const shard = input.headers.get("x-fragno-shard");
  output.deps.shardContext.set(shard ?? null);
};

const fragment = createCommentFragment(
  { shardingStrategy: { mode: "row" } },
  { databaseAdapter },
).withMiddleware(shardMiddleware);

getInternalFragment(databaseAdapter).withMiddleware(shardMiddleware);
```

Shards must be **non-empty** and **`<= 64` characters** when set. Use `null` when no shard is
available.

### Lofi + Outbox Sharding

Lofi is **shard-agnostic**. Shard filtering happens on the server, and Lofi only receives
shard-filtered data from `/_internal/outbox` and `/_internal/sync`.

Outbox mutation payloads may include `_shard` (a system column). Clients must ignore `_shard` in
payloads and never attempt to read or write it.

<Callout title="Direct Query Engine Access" type="warning">
  Database fragments do not expose a direct query engine. Use `handlerTx` or `serviceTx` so shard
  filtering and UOW semantics are always enforced.
</Callout>

### Join Limitations

Cross-shard joins are disallowed. In row mode, every table in a join must be filtered by the same
shard. If your adapter cannot enforce this, the query will throw.

## FAQ

**Q: Do I need to learn a new ORM?**

A: No. You continue using your existing Kysely, Drizzle, or Prisma setup. The Fragment just adds its
tables to your database.

**Q: Can I query Fragment tables directly?**

A: Yes, but there are some caveats. In general we recommend using the Fragment's service methods
instead. You can query the Fragment's tables directly, but you have to be aware of the fact that the
Fragment author may change the schema in the future.

**Q: What if I don't use Kysely, Drizzle, or Prisma?**

A: Fragno uses Kysely dialects under the hood and currently supports SQL migrations plus Drizzle or
Prisma schema outputs. Support for other workflows may be added in the future. Please let us know on
[GitHub](https://github.com/rejot-dev/fragno/discussions) if you'd like to see additional formats.

**Q: Can I use multiple database Fragments?**

A: Yes! Each Fragment manages its own namespaced tables. You can use the same adapter for all
Fragments:

```typescript
const comments = createCommentFragment({}, { databaseAdapter });
const ratings = createRatingFragment({}, { databaseAdapter });
```

## Next Steps

Choose your database workflow to continue:

- [Database Adapter](/docs/fragno/for-users/database-fragments/database-adapter)
- [CLI Reference](/docs/reference/cli) for migration commands
