---
title: Querying
description: Using the DB to query and manipulate data
---

import { Callout } from "fumadocs-ui/components/callout";

Fragno DB queries are type-safe and based on your schema. The recommended way to query is via the
**Unit of Work (UOW)** helpers on the `this` context, so reads/writes can be **composed** and
**batched** into a single transaction.

## Querying with `this.uow(...)`

There are two places you’ll use UOWs:

- **Services**: `this.uow(schema)` gives a **restricted UOW** that can schedule operations and await
  `retrievalPhase` / `mutationPhase`.
- **Route handlers**: `this.uow(callback, options)` controls execution and runs `executeRetrieve()`
  / `executeMutate()` (with retries on optimistic conflicts).

See [Transactions](/docs/fragno/for-library-authors/database-integration/transactions) for the full
pattern.

<Callout title="Use function syntax in services" type="warn">
  Service methods should be defined with `defineService({ ... })` and use `function (...) { ... }`
  syntax so `this.uow(...)` is available and typed. Arrow functions (`() => {}`) don’t have their
  own `this`.
</Callout>

## Finding Records

### Index-Based Queries

All `find(...)` and `findFirst(...)` queries must specify an index using `whereIndex()`. This
ensures optimal performance and predictable query patterns.

```typescript
const uow = this.uow(mySchema).find("users", (b) =>
  b.whereIndex("idx_email", (eb) => eb("email", "=", "user@example.com")),
);
const [users] = await uow.retrievalPhase;
```

<Callout title="Why Index-Based Queries?" type="info">
  Requiring indexes for all queries ensures consistent performance and prevents slow table scans.
</Callout>

### Basic Queries

Find all users (table scan using the primary index):

```typescript
const uow = this.uow(mySchema).find("users", (b) => b.whereIndex("primary"));
const [users] = await uow.retrievalPhase;
```

Select specific columns:

```typescript
const uow = this.uow(mySchema).find("users", (b) => b.whereIndex("primary").select(["id", "name"]));
const [userNames] = await uow.retrievalPhase;
```

Count records:

```typescript
const uow = this.uow(mySchema).find("users", (b) => b.whereIndex("primary").selectCount());
const [userCount] = await uow.retrievalPhase;
```

Use `find(...)` when you want **an array of results**:

```typescript
const uow = this.uow(mySchema).find("users", (b) =>
  b.whereIndex("idx_email", (eb) => eb("email", "contains", "@example.com")),
);
const [users] = await uow.retrievalPhase;
// users is User[]
```

Use `findFirst(...)` when you want **a single row (or null)**:

```typescript
const uow = this.uow(mySchema).findFirst("users", (b) =>
  b.whereIndex("idx_email", (eb) => eb("email", "=", "user@example.com")),
);
const [user] = await uow.retrievalPhase;
// user is User | null
```

### Cursor-Based Pagination

Use cursor-based pagination for efficient paging through large result sets. Fragno DB provides
`findWithCursor()` which automatically generates cursors from query results:

```typescript
const uow = this.uow(mySchema).findWithCursor("users", (b) =>
  b.whereIndex("idx_name").orderByIndex("idx_name", "asc").pageSize(10),
);

const [firstPage] = await uow.retrievalPhase;

// firstPage.items
// firstPage.cursor?.encode()

// Fetch next page
const uow2 = this.uow(mySchema).findWithCursor("users", (b) => b.after(firstPage.cursor));
const [nextPage] = await uow2.retrievalPhase;
```

<Callout title="When to Use findWithCursor()" type="info">
  Use `findWithCursor()` when you need pagination metadata. Use regular `find()` when you don't need
  cursors. Both methods support the same query building features.
</Callout>

### Ordering

Sort results using indexes:

```typescript
const uow = this.uow(mySchema).find("users", (b) =>
  b.whereIndex("idx_created").orderByIndex("idx_created", "desc"),
);
const [users] = await uow.retrievalPhase;
```

### Joins

Load related data using joins:

```typescript
const uow = this.uow(mySchema).find("posts", (b) =>
  b.whereIndex("primary").join((j) => j.author()),
);
const [postsWithAuthor] = await uow.retrievalPhase;
```

Note: We currently only support simple left joins.

## Creating Records

```typescript
const uow = this.uow(mySchema);

// Schedule create
const userId = uow.create("users", {
  name: "Alice",
  email: "alice@example.com",
  age: 25,
});

// Wait until the handler commits (or call executeMutate() if you're in a handler)
await uow.mutationPhase;

// Columns with defaultTo$() are auto-populated
uow.create("posts", {
  title: "My Post",
  content: "Content here",
  userId: userId.toString(),
  // createdAt auto-generated via defaultTo$("now")
});
await uow.mutationPhase;
```

## Updating Records

```typescript
// Update by ID
const uow = this.uow(mySchema);
uow.update("users", userId, (b) => b.set({ name: "Alice Updated", age: 26 }));
await uow.mutationPhase;
```

## Deleting Records

```typescript
// Delete by ID
const uow = this.uow(mySchema);
uow.delete("users", userId);
await uow.mutationPhase;
```

## Transactions

For atomic operations, batching, and the recommended “routes execute, services enqueue” pattern, see
[Transactions](/docs/fragno/for-library-authors/database-integration/transactions).

## Alternative: using `db` from dependencies (no multi-operation transactions)

You can access the `db` object directly inside the `withDependencies()` callback. Operations execute
immediately as individual queries. This can be convenient for simple tasks, but you lose the key
benefits of the UOW pattern:

- **No multi-operation atomicity** across several reads/writes (no single transaction boundary).
- **No optimistic concurrency control** via `.check()` (and no automatic retries).
- **No durable hooks integration**, because hooks are recorded during the UOW mutation phase.

Keep `db` usage for cases where you don’t need transactional composition.

## Next Steps

- See
  [Dependencies and Services](/docs/fragno/for-library-authors/features/dependencies-and-services)
  for using the DB in context
- Check the
  [example-fragments/fragno-db-library](https://github.com/rejot-dev/fragno/tree/main/example-fragments/fragno-db-library)
