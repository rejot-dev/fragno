---
import { createExampleFragmentClient } from "@rejot-dev/example-fragment";
import { useVanilla } from "@rejot-dev/fragno/client/vanilla";

const exampleFragmentClient = createExampleFragmentClient();
const { useData } = useVanilla(exampleFragmentClient);

// Get initial data during SSR
const initialData = await useData();
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Astro Fragno Example Fragment</title>
  </head>
  <body>
    <div style="padding: 20px; font-family: monospace; max-width: 800px; margin: 0 auto">
      <h1>Astro Fragno Example Fragment</h1>
      <p>Simple data reading with example-fragment</p>

      <div style="margin-bottom: 30px">
        <h2>Current Data</h2>
        <div
          id="data-display"
          style="padding: 15px; background-color: #f5f5f5; border-radius: 5px; border: 1px solid #ddd">
          {initialData || "No data yet"}
        </div>
      </div>

      <div style="margin-top: 30px; font-size: 14px; color: #666">
        <h3>Available Endpoints:</h3>
        <ul>
          <li>GET /api/example-fragment/ - Hello World</li>
          <li>GET /api/example-fragment/data - Retrieve current data</li>
          <li>POST /api/example-fragment/sample - Mutate data</li>
        </ul>
      </div>

      <div style="margin-top: 30px; font-size: 14px; color: #666">
        <button id="mutateBtn">Click me to mutate data</button>
      </div>
    </div>

    <script>
      // Client-side JavaScript for interactivity
      import { createExampleFragmentClient } from "@rejot-dev/example-fragment";
      import { useVanilla } from "@rejot-dev/fragno/client/vanilla";

      const exampleFragmentClient = createExampleFragmentClient();
      const { useData, useSampleMutator } = useVanilla(exampleFragmentClient);

      // Initialize client-side data hook
      const dataHook = useData();

      // Set initial data from server
      dataHook.data =
        document.getElementById("data-display")?.textContent ||
        "No data yet";

      const mutateBtn = document.getElementById("mutateBtn");

      if (mutateBtn) {
        mutateBtn.addEventListener("click", async () => {
          try {
            const currentData = dataHook.data || "";
            const result = await useSampleMutator({ message: currentData + "!" });

            // Update the displayed data
            const dataDiv = document.getElementById("data-display");
            if (dataDiv) {
              dataDiv.textContent = result;
            }

            // Update the hook's data
            dataHook.data = result;
          } catch (error) {
            console.error("Mutation failed:", error);
          }
        });
      }
    </script>
  </body>
</html>
